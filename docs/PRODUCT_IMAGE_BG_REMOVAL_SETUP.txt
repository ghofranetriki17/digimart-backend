Product Images - Background Removal (rembg Self-Hosted)
========================================================

Objectif
--------
Ajouter la suppression d'arriere-plan pour les images produit, de facon propre:
- backend: proxy vers rembg (feature toggle + timeout + validation)
- frontend: bouton par image dans le ProductForm
- flux de sauvegarde existant conserve (upload final au submit)


Architecture retenue
--------------------
1) Frontend envoie un fichier a /api/products/images/remove-background
2) Backend valide l'image puis appelle rembg (self-hosted)
3) Backend retourne l'image traitee en binaire (pas de persistence immediate)
4) Frontend ajoute l'image traitee a cote de l'image source (sans ecraser l'originale)
5) A l'enregistrement produit, pipeline upload existant est reutilise

Pourquoi ce choix:
- pas de fichiers orphelins si l'utilisateur annule le formulaire
- aucune rupture du flux actuel de creation/modification produit
- migration facile vers fallback cloud plus tard


Ce qui a ete implemente
-----------------------
Backend:
1) Endpoint API:
   POST /api/products/images/remove-background
   consumes: multipart/form-data
   param: file
   retourne: image binaire (png/jpg/webp/gif)

2) Service dedie:
   digimart-api/src/main/java/com/nexashop/api/service/ProductImageBackgroundRemovalService.java
   - feature toggle: image.bg-removal.enabled
   - timeout configurable
   - appel HTTP multipart vers rembg
   - validation forte sur type/size
   - watermark auto si le plan n'a pas NO_PLATFORM_WATERMARK
   - si le plan a CUSTOM_WATERMARK, le watermark devient le nom du tenant
   - sinon watermark plateforme (Digimart)

3) Renforcement utilitaire upload:
   digimart-api/src/main/java/com/nexashop/api/util/UploadUtil.java
   - validation image centralisee (validateImage)
   - stockage bytes disponible (storeImageBytes) pour evolutions futures

4) Config:
   digimart-api/src/main/resources/application.properties
   - image.bg-removal.enabled=false
   - image.bg-removal.rembg-url=http://localhost:5000
   - image.bg-removal.rembg-endpoint=/api/remove
   - image.bg-removal.timeout-seconds=30
   - image.bg-removal.platform-watermark-enabled=true
   - image.bg-removal.platform-watermark-text=Digimart

Frontend:
1) Bouton suppression fond par image dans ProductForm:
   src/components/organisms/ProductFormModal/ProductFormModal.jsx
   src/components/organisms/ProductFormModal/ProductFormModal.css

2) Integration pipeline:
   src/pages/catalog/ProductsPage.jsx
   - call API remove-background
   - ajout local de l'image traitee dans imageQueue
   - support image "existing" et "new"
   - gestion du cas "existing remplacee": pending delete propre avant reorder/save


Pre-requis local
----------------
1) Python 3.10+ installe
2) rembg installe:
   pip install rembg
3) Lancer rembg server:
   rembg s --port 5000

Commande test rapide rembg:
curl -F "file=@C:\path\image.png" http://localhost:5000/api/remove --output out.png


Activation backend
------------------
Dans application.properties (ou variable env), activer:

image.bg-removal.enabled=true
image.bg-removal.rembg-url=http://localhost:5000
image.bg-removal.rembg-endpoint=/api/remove
image.bg-removal.timeout-seconds=30
image.bg-removal.platform-watermark-enabled=true
image.bg-removal.platform-watermark-text=Digimart

Puis redemarrer l'API.


Etapes de verification manuelle (end-to-end)
---------------------------------------------
1) Ouvrir la page Produits -> Ajouter/Modifier produit
2) Aller a l'etape Images
3) Ajouter une image
4) Cliquer l'icone "magic" sur l'image
5) Verifier:
   - image source conservee
   - image traitee ajoutee en preview
   - pas d'erreur API
6) Enregistrer le produit
7) Re-ouvrir le produit et verifier:
   - image traitee presente
   - ordre des images correct

Cas edition image existante:
1) Ouvrir un produit avec images existantes
2) Cliquer "magic" sur une image existante
3) Enregistrer
4) Verifier:
   - image originale conservee
   - image traitee ajoutee
   - reorder ok


API contract (reference)
------------------------
Request:
POST /api/products/images/remove-background
Content-Type: multipart/form-data
Body:
  file=<image png/jpg/webp/gif max 20MB>

Response success:
HTTP 200
Content-Type: image/png (ou autre image/*)
Body: bytes image traitee

Errors:
- 400/413: image invalide (type/size)
- 503: feature desactivee
- 502: rembg indisponible ou erreur upstream


Checklist robustesse
--------------------
1) Validation size/type au backend (fait)
2) Timeout HTTP vers rembg (fait)
3) Gestion interruption thread (fait)
4) Erreurs upstream lisibles cote frontend (fait)
5) Pas de persistence anticip√©e lors du remove-bg (fait)
6) Feature toggle pour rollback instantane (fait)


Plan de migration production (post-PFE)
---------------------------------------
Phase 1 (0-10k images/mois):
- rembg self-hosted uniquement

Phase 2:
- rembg primary + fallback API cloud (circuit breaker)

Phase 3:
- routage par plan tenant (premium vs enterprise)


Monitoring recommande
---------------------
A instrumenter des que possible:
- latence remove-background p50/p95
- taux echec rembg
- volume images/jour
- erreurs par tenant


Troubleshooting
---------------
Symptome: HTTP 502 "service unreachable"
Action:
- verifier rembg lance sur bon port
- verifier image.bg-removal.rembg-url
- tester curl direct sur rembg

Symptome: image non remplacee dans form
Action:
- verifier console frontend
- verifier reponse endpoint /api/products/images/remove-background
- verifier token auth envoye

Symptome: save echoue apres remplacement image existante
Action:
- verifier delete pending images + reorder sequence
- verifier logs API sur endpoints /images/{id} et /images/order


Commandes utilisees pendant implementation
------------------------------------------
Backend compile:
  ./mvnw -pl digimart-api -am -DskipTests compile

Frontend build:
  npm run build

Terminal 1: rembg
  C:\Users\agence digilab\AppData\Local\Programs\Python\Python313\Scripts\rembg.exe s -h 127.0.0.1 -p 5000 -l info -t 1

Terminal 2: backend
  cd C:\Dev\digimart-backend
  $env:IMAGE_BG_REMOVAL_ENABLED="true"
  $env:IMAGE_BG_REMOVAL_REMBG_URL="http://127.0.0.1:5000"
  $env:IMAGE_BG_REMOVAL_REMBG_ENDPOINT="/api/remove"
  $env:IMAGE_BG_REMOVAL_TIMEOUT_SECONDS="180"
  .\mvnw -pl digimart-api -am spring-boot:run
