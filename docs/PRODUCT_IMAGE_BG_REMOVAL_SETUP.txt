Product Images - Background Removal + Watermark + Focus (Current Setup)
=================================================================

Objectif
--------
Documenter la version actuelle de l image studio produit:
- remove background (rembg self-hosted)
- change background (studio tenant ou upload one-shot)
- add watermark (platform ou custom)
- focus image X/Y (partie visible) applique dans les cards


1) Architecture actuelle
------------------------
Flux image processing:
1. Front envoie un fichier vers une API /api/products/images/*
2. Backend valide type/size
3. Backend appelle rembg si necessaire
4. Backend retourne des bytes image (pas de save immediate)
5. Front ajoute le resultat dans imageQueue (sans ecraser l originale)
6. Save final du produit => upload/reorder pipeline existant

Principes:
- originale conservee
- derivee ajoutee a cote
- pas de fichier orphan si user annule avant submit


2) Endpoints backend
--------------------
A) Remove background
POST /api/products/images/remove-background
Body multipart:
- file=<png|jpg|webp|gif, max 20MB>
Retour: bytes image (image/*)

B) Change background
POST /api/products/images/change-background
Body multipart:
- file=<png|jpg|webp|gif, max 20MB>
- fit=COVER|CONTAIN (optional, default COVER)
- backgroundFile=<optional>
Retour: bytes image (image/*)

C) Add watermark only (sans remove-bg)
POST /api/products/images/add-watermark
Body multipart:
- file=<png|jpg|webp|gif, max 20MB>
- mode=AUTO|PLATFORM|CUSTOM
Retour: bytes image (image/*)

D) Upload studio background (1 background par tenant)
POST /api/tenants/{id}/studio-background
Body multipart:
- file=<png|jpg|webp|gif, max 20MB>
Retour: TenantResponse avec studioBackgroundUrl

E) Focus image (partie visible)
PUT /api/products/{id}/images/{imageId}/focus
Body JSON:
{
  "focusX": 0..100,
  "focusY": 0..100
}
Retour: ProductImageResponse


3) Watermark rules (important)
------------------------------
Feature codes utilises:
- NO_PLATFORM_WATERMARK
- CUSTOM_WATERMARK
- BACKGROUND_REMOVAL
- BACKGROUND_CHANGE

Regles:
- remove-background: applique watermark platforme automatiquement
  sauf si tenant a NO_PLATFORM_WATERMARK.
- add-watermark mode=CUSTOM: autorise seulement si CUSTOM_WATERMARK actif.
- Une seule couche watermark appliquee a la fois:
  texte OU logo (jamais les deux).

Config platform watermark (admin/billing config):
- PLATFORM_WATERMARK_ENABLED=true|false
- PLATFORM_WATERMARK_KIND=TEXT|IMAGE
- PLATFORM_WATERMARK_TEXT=<texte>
- PLATFORM_WATERMARK_LOGO_URL=/uploads/...


4) Focus X/Y (partie visible)
-----------------------------
Stockage:
- product_images.focus_x (default 50)
- product_images.focus_y (default 50)

Expose API:
- ProductImageResponse.focusX/focusY
- ProductResponse.imageFocusX/imageFocusY
- ProductDetailsResponse.imageFocusX/imageFocusY
- ProductVariantResponse.productImageFocusX/productImageFocusY

Comportement front:
- Si X/Y absent => fallback centre 50/50
- X/Y utilise object-position
- Product cards: zoom hover image retire pour eviter perception fausse de Y
- Lors fermeture form produit, focus des images existantes est persiste
  (pas uniquement au submit)


5) Fichiers principaux modifies
-------------------------------
Backend:
- digimart-api/src/main/java/com/nexashop/api/service/ProductImageBackgroundRemovalService.java
- digimart-api/src/main/java/com/nexashop/api/controller/catalog/ProductController.java
- digimart-api/src/main/java/com/nexashop/api/controller/store/StoreController.java
- digimart-api/src/main/java/com/nexashop/api/dto/request/product/UpdateProductImageFocusRequest.java
- digimart-api/src/main/java/com/nexashop/api/dto/response/product/ProductImageResponse.java
- digimart-api/src/main/java/com/nexashop/api/dto/response/product/ProductResponse.java
- digimart-api/src/main/java/com/nexashop/api/dto/response/product/ProductDetailsResponse.java
- digimart-api/src/main/java/com/nexashop/api/dto/response/product/ProductVariantResponse.java
- digimart-application/src/main/java/com/nexashop/application/usecase/ProductUseCase.java
- digimart-domain/src/main/java/com/nexashop/domain/catalog/entity/ProductImage.java
- digimart-infrastructure/src/main/java/com/nexashop/infrastructure/persistence/model/catalog/ProductImageJpaEntity.java
- digimart-infrastructure/src/main/java/com/nexashop/infrastructure/persistence/mapper/ProductImageMapper.java

Frontend:
- C:/Dev/nexashop-frontend/src/pages/catalog/ProductsPage.jsx
- C:/Dev/nexashop-frontend/src/components/organisms/ProductFormModal/ProductFormModal.jsx
- C:/Dev/nexashop-frontend/src/components/organisms/ProductFormModal/ProductFormModal.css
- C:/Dev/nexashop-frontend/src/components/molecules/ProductCard/ProductCard.jsx
- C:/Dev/nexashop-frontend/src/components/molecules/ProductCard/ProductCard.css
- C:/Dev/nexashop-frontend/src/pages/pos/PosPage.jsx
- C:/Dev/nexashop-frontend/src/pages/stores/StoresPage.jsx
- C:/Dev/nexashop-frontend/src/components/organisms/ProductDetailsModal/ProductDetailsModal.jsx


6) Pre-requis local
-------------------
Python:
- Python 3.13 recommande dans ce poste
- Installer rembg:
  py -3.13 -m pip install "rembg[cli]"

Run rembg server:
- C:\Users\agence digilab\AppData\Local\Programs\Python\Python313\Scripts\rembg.exe s -h 127.0.0.1 -p 5000 -l info -t 1

Backend run:
- cd C:\Dev\digimart-backend
- $env:IMAGE_BG_REMOVAL_ENABLED="true"
- $env:IMAGE_BG_REMOVAL_REMBG_URL="http://127.0.0.1:5000"
- $env:IMAGE_BG_REMOVAL_REMBG_ENDPOINT="/api/remove"
- $env:IMAGE_BG_REMOVAL_TIMEOUT_SECONDS="180"
- .\mvnw -pl digimart-api -am spring-boot:run

Note:
- image.bg-removal.enabled=false dans application.properties par defaut
  => activer via env pour dev local.


7) Verification rapide (E2E)
----------------------------
A) Remove-bg + watermark
1. Ouvrir produit > Images
2. Cliquer remove background
3. Verifier image derivee ajoutee
4. Si plan N A PAS NO_PLATFORM_WATERMARK => watermark visible

B) Change background
1. Cliquer change background
2. Sans backgroundFile, doit utiliser tenant studio background
3. Verifier resultat ajoute dans queue

C) Focus X/Y
1. Selectionner image
2. Modifier X et Y
3. Quitter modal et rouvrir
4. Verifier card produit suit X et Y


8) Troubleshooting
------------------
503 "Background removal is disabled"
- IMAGE_BG_REMOVAL_ENABLED=true manquant.

502 "service unreachable"
- rembg non lance, mauvais port, timeout trop court.

Watermark absent alors qu attendu
- verifier PLATFORM_WATERMARK_ENABLED=true
- verifier tenant n a pas feature NO_PLATFORM_WATERMARK
- verifier PLATFORM_WATERMARK_KIND + TEXT/LOGO URL configures

X ok, Y semble non applique
- verifier que image n est pas deja saturant verticalement avec object-fit:cover
- verifier que zoom hover image est desactive sur ProductCard
- verifier focusY sauvegarde en base et renvoye par API


9) Build commands
-----------------
Backend compile:
- .\mvnw -pl digimart-api -am -DskipTests compile

Frontend build:
- cd C:\Dev\nexashop-frontend
- npm run build


10) Next hardening (recommande)
-------------------------------
- Ajouter tests backend watermark (with/without NO_PLATFORM_WATERMARK)
- Ajouter migration SQL explicite focus_x/focus_y
- Ajouter logs explicites "watermark applied/skipped + reason"
