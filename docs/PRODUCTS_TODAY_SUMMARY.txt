PRODUITS - AJOUTS DU JOUR (LOGIQUE + ETAPES)
===========================================

Date: 2026-02-11
Contexte: V1 catalogue produits + CSV + images + stock par magasin + pagination + historique prix

Notes futures:
- Ajouter variantes/options, AI, generation images, suppression plans, stats globales.
- Ajouter stats en haut (nb produits, valeur stock si stock global).

1) IMPORT / EXPORT CSV (PRODUITS UNIQUEMENT)
--------------------------------------------
Objectif:
- Importer des produits via CSV (sans images, sans categories).
- Exporter un template CSV + exporter les produits existants.

Backend:
- POST /api/products/import?tenantId={id} (multipart/form-data file)
- GET  /api/products/export/template
- GET  /api/products/export?tenantId={id}

Colonnes CSV:
name, description, initial_price, final_price, cost_price,
shipping_price, shipping_cost_price

Validation:
- name obligatoire
- initial_price obligatoire
- shipping_price obligatoire

Notes:
- slug auto-genere (base sur name).
- categories/images exclues volontairement (ajout manuel apres import).

Frontend:
- Boutons: Template CSV / Export CSV / Importer CSV
- Rapport d'import + erreurs par ligne.

2) IMAGES PRODUITS
------------------
Objectif:
- Ajouter plusieurs images, reordonner, 1ere = primary.

Backend:
- POST /api/products/{id}/images
- PUT  /api/products/{id}/images/order
- DELETE /api/products/{id}/images/{imageId}

Frontend:
- Dropzone + preview.
- Reorder en local (drag + up/down), puis 1 call pour sauvegarde.
- La 1ere image = primary.
- Bouton supprimer image (DELETE). Si image existante, re-sauvegarde l'ordre restant pour recalculer le primary.

3) STOCK PAR MAGASIN (INVENTORY)
--------------------------------
Objectif:
- trackStock = true -> stock par magasin.
- trackStock = false -> stock global.

Backend:
- inventories[] sur create/update.
- replaceInventory: une ligne par magasin.

Frontend:
- Toggle "Suivre le stock par magasin"
- Tableau stocks par magasin si actif.

4) DISPONIBILITE PRODUIT
------------------------
Status: ACTIVE | HIDDEN | OUT_OF_STOCK
Availability: IN_STOCK | ON_ORDER | PRE_ORDER

availabilityText:
- IN_STOCK / ON_ORDER -> message libre (delai, etc)
- PRE_ORDER -> date/heure (input datetime-local)
  Format: YYYY-MM-DDTHH:MM (sert au compte a rebours)

Validation:
- PRE_ORDER + status ACTIVE => date obligatoire
- OUT_OF_STOCK => date non obligatoire

5) PRICING + VALIDATION + MARGE (INFO ONLY)
-------------------------------------------
Validation:
- finalPrice <= initialPrice (sinon erreur claire)

Marge (info):
(finalPrice si present, sinon initialPrice)
 + shippingPrice
 - shippingCostPrice
 - costPrice

Affichage:
- TND + %
- uniquement dans Resume (pas dans l'etape Prix)

6) FORMULAIRE PRODUIT (WIZARD)
------------------------------
Steps:
1. Infos
2. Prix
3. Categories
4. Stock
5. Images

Raccourcis:
- En edition: bouton "Enregistrer" disponible a tout moment.

Champs obligatoires:
- Nom *
- Prix initial *
- Frais de livraison *

Champs caches:
- SKU (genere/stocke en back, pas visible en front)
- Slug (auto-genere)

7) PAGINATION + FILTRES (SERVER-SIDE)
-------------------------------------
Endpoint:
- GET /api/products/paged

Filtres:
- status, availability, stockLow, minPrice, maxPrice, search, categoryId

Pagination:
- page, size (default 8)
- search pagine aussi (pas de filtrage local)

8) HISTORIQUE PRIX + PRIX LE PLUS BAS
-------------------------------------
Table:
- product_price_history (product_id, initial_price, final_price, changed_at, changed_by)
- enregistre a chaque changement de prix

Backend:
- GET /api/products/{id}/price-history (paged)
- lowest price calcule (30 jours -> fallback all-time)
- showLowestPrice bool (default false)

Frontend:
- Onglet "Historique prix" (graph + liste)
- Chip "Prix le plus bas 30j" sur card si showLowestPrice=true

9) STOCK BAS (INDICATEUR + FILTRE)
----------------------------------
Backend:
- lowStock calcule (global ou par magasin)
- retourne lowStock dans ProductResponse/Details

Frontend:
- Badge "Stock bas" sur card
- Filtre "Stock faible"

10) DETAILS PRODUIT (MODAL + TABS)
----------------------------------
Acces:
- clic sur image ou nom dans la card

Tabs:
- Historique commandes (placeholder)
- Historique prix (graph + liste)
- Disponibilite magasin (liste cliquable)

Disponibilite magasin:
- trackStock=false -> "Tous les magasins"
- trackStock=true -> liste des magasins actifs (click -> page magasins)

11) BULK ACTIONS
----------------
- Selection multiple (checkbox)
- Actions:
  - Modifier prix (bulk)
  - Modifier statut (bulk)
  - Supprimer (bulk)
- "Tout selectionner" applique a la page courante

FICHIERS PRINCIPAUX (BACK)
--------------------------
- digimart-api/.../ProductController.java
- digimart-api/.../dto/response/product/ProductPriceHistoryResponse.java
- digimart-application/.../usecase/ProductUseCase.java
- digimart-application/.../port/out/ProductPriceHistoryRepository.java
- digimart-infrastructure/.../ProductPriceHistoryJpaRepository.java
- digimart-infrastructure/.../ProductPriceHistoryRepositoryAdapter.java
- digimart-infrastructure/.../ProductStoreInventoryRepositoryAdapter.java

FICHIERS PRINCIPAUX (FRONT)
---------------------------
- src/pages/catalog/ProductsPage.jsx
- src/pages/catalog/ProductsPage.css
- src/components/molecules/ProductCard/ProductCard.jsx
- src/components/molecules/ProductCard/ProductCard.css
- src/components/molecules/PriceHistoryChart/PriceHistoryChart.jsx
- src/components/molecules/PriceHistoryChart/PriceHistoryChart.css

TEST THUNDER CLIENT (EXEMPLES)
------------------------------
1) Import CSV:
POST http://localhost:8080/api/products/import?tenantId=1
Body: form-data -> file: products.csv

2) Export template:
GET http://localhost:8080/api/products/export/template

3) Export data:
GET http://localhost:8080/api/products/export?tenantId=1

4) Upload image:
POST http://localhost:8080/api/products/1/images
form-data -> file: image.png

5) Reorder images:
PUT http://localhost:8080/api/products/1/images/order
Body: {"imageIds":[12,14,15]}

5b) Supprimer image:
DELETE http://localhost:8080/api/products/1/images/12

6) Historique prix:
GET http://localhost:8080/api/products/1/price-history?page=0&size=20
